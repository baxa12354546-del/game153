<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RPG: Final Credits</title>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
    <style>
        /* --- –ë–ê–ó–ê --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #111; margin: 0; padding: 0; overflow: hidden; 
            user-select: none; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center; color: white;
        }

        #main-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -3; transition: background 0.8s ease; }

        #game-wrapper {
            width: 1000px; height: 750px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 20px; padding: 20px;
            background: rgba(0,0,0,0.2); box-sizing: border-box;
        }

        .screen { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; animation: fade 0.3s ease-out; justify-content: center; }
        #scr-battle { justify-content: flex-start; padding-top: 10px; }
        .active { display: flex; }
        @keyframes fade { from{opacity:0; transform: scale(0.95);} to{opacity:1; transform: scale(1);} }

        #fs-btn {
            position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.15); color: white;
            border: 1px solid rgba(255,255,255,0.5); padding: 8px 16px; cursor: pointer; z-index: 5000; border-radius: 20px; font-family: 'Russo One';
        }

        /* --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø --- */
        #ach-toast {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            color: black; padding: 15px 30px; border-radius: 50px;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            display: flex; align-items: center; gap: 15px; z-index: 6000;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast-icon { font-size: 30px; }
        .toast-text { font-family: 'Russo One'; text-transform: uppercase; }

        /* --- –î–ò–ê–õ–û–ì–ò --- */
        #dialogue-overlay {
            display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 180px; z-index: 4000;
            background: rgba(0, 0, 0, 0.9); border: 4px solid #fff; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,1);
            animation: slideUp 0.3s ease-out; cursor: pointer;
        }
        @keyframes slideUp { from{transform:translate(-50%, 50px); opacity:0;} to{transform:translate(-50%, 0); opacity:1;} }
        .dia-content { display: flex; align-items: center; height: 100%; padding: 0 20px; gap: 20px; }
        .dia-portrait { width: 120px; height: 120px; font-size: 100px; background: #333; border: 3px solid #f1c40f; border-radius: 50%; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .dia-text-box { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .dia-name { color: #f1c40f; font-family: 'Russo One'; font-size: 24px; margin-bottom: 10px; text-transform: uppercase; }
        .dia-msg { font-size: 22px; line-height: 1.4; color: #eee; }

        /* --- –ö–ê–†–¢–ê --- */
        .zones-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 900px; height: 500px; overflow-y: auto; padding-right: 10px; }
        .zone-card { background: rgba(0,0,0,0.6); border: 2px solid #555; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; gap: 10px; transition: 0.2s; backdrop-filter: blur(5px); }
        .zone-card:hover { border-color: white; background: rgba(0,0,0,0.7); }
        .zone-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .z-title { font-family: 'Russo One'; font-size: 22px; color: #fff; }
        .levels-row { display: flex; gap: 10px; justify-content: space-between; }
        
        /* –ö–ù–û–ü–ö–ò –ò –ó–ê–ú–ö–ò */
        .lvl-btn { flex: 1; padding: 10px 0; border: none; border-radius: 8px; font-family: 'Russo One'; font-size: 16px; color: white; cursor: pointer; background: #34495e; border-bottom: 4px solid #2c3e50; transition: 0.1s; position: relative; }
        .lvl-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .lvl-boss { background: #c0392b; border-color: #922b21; }
        .lvl-btn.locked { background: #222 !important; border-color: #111 !important; color: #555; cursor: not-allowed; pointer-events: none; }
        .lvl-btn.locked::after { content: "üîí"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; }

        /* –ë–û–ô */
        .battle-top { width: 100%; height: 80px; display: grid; grid-template-columns: 140px 1fr 140px; align-items: center; background: rgba(0,0,0,0.6); padding: 0 15px; border-radius: 15px; margin-bottom: 10px; box-sizing: border-box; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 100; }
        .center-info { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        .stage-bar { display: flex; gap: 10px; margin-bottom: 5px; }
        .stage-pip { width: 20px; height: 20px; background: #333; border: 2px solid #555; transform: rotate(45deg); transition: 0.3s; box-shadow: 0 0 5px black; }
        .stage-pip.active { background: #f1c40f; border-color: #f39c12; box-shadow: 0 0 10px #f1c40f; }
        .stage-pip.passed { background: #27ae60; border-color: #2ecc71; }
        .top-row-stats { display: flex; gap: 20px; align-items: center; }
        .gold-display { font-family: 'Russo One'; color: #f1c40f; font-size: 22px; display: flex; align-items: center; gap: 5px; text-shadow: 0 2px 0 black; }
        .timer-box { font-family: 'Russo One'; font-size: 30px; color: white; border: 3px solid white; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.5); transition: 0.2s; }
        .timer-low { color: #e74c3c; border-color: #e74c3c; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
        .btn-small { background: #333; color: white; border: 2px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 8px; font-family: 'Russo One'; font-size: 14px; position: relative; z-index: 101; }
        .btn-small:hover { background: #555; border-color: white; }
        #shop-btn { background: #e67e22; border-color: #d35400; width: 100%; height: 40px; font-size: 18px; }

        /* –ò–ù–í–ï–ù–¢–ê–†–¨ */
        .inventory-bar { display: flex; gap: 10px; margin-top: 10px; justify-content: center; position: relative; z-index: 102; }
        .inv-item { background: rgba(0,0,0,0.7); border: 2px solid #777; padding: 5px 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.1s; }
        .inv-item:hover { border-color: white; background: rgba(50,50,50,0.9); transform: translateY(-2px); }
        .inv-count { font-family: 'Russo One'; font-size: 16px; color: gold; }

        /* –û–ë–©–ò–ï */
        h1 { color: #f1c40f; text-shadow: 3px 3px 0 #000; text-transform: uppercase; margin: 15px; font-size: 48px; font-family: 'Russo One'; }
        .btn { padding: 15px 40px; background: #d35400; border: none; border-radius: 12px; border-bottom: 5px solid #a04000; color: white; font-weight: bold; font-size: 24px; cursor: pointer; transition: 0.1s; font-family: 'Russo One'; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .hero-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .hero-card { background: rgba(30, 30, 30, 0.85); padding: 15px; border: 2px solid #555; border-radius: 15px; width: 140px; text-align: center; cursor: pointer; transition: 0.2s; }
        .hero-card:hover { border-color: #f1c40f; transform: scale(1.05); background: rgba(50,50,50,0.9); }
        .h-icon { font-size: 60px; display: block; margin-bottom: 5px; }

        /* –°–¶–ï–ù–ê */
        .scene { display: flex; justify-content: space-between; align-items: flex-end; width: 95%; height: 220px; margin-bottom: 10px; position: relative; z-index: 1; }
        .char { text-align: center; width: 250px; position: relative; display: flex; flex-direction: column; align-items: center; }
        .char-vis { font-size: 130px; filter: drop-shadow(0 10px 10px black); line-height: 1; transition: transform 0.1s; }
        .hp-bar { width: 100%; height: 20px; background: #111; border: 2px solid #000; margin-top: 5px; border-radius: 10px; overflow: hidden; }
        .hp-fill { height: 100%; transition: width 0.3s ease-out; }
        .hp-h { background: linear-gradient(90deg, #2ecc71, #27ae60); } 
        .hp-e { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        /* –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê */
        .math-container { display: flex; flex-direction: column; align-items: center; width: 100%; flex-grow: 1; z-index: 5; position: relative; }
        .math-display { background: rgba(0, 0, 0, 0.8); border: 3px solid #fff; padding: 5px 50px; border-radius: 15px; font-family: 'Russo One', sans-serif; font-size: 50px; color: #fff; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        .q-mark { color: #8e44ad; font-weight: bold; text-shadow: 0 0 10px #e056fd; }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 700px; margin-bottom: 10px; }
        .ans-btn { background: #2c3e50; color: white; border: 3px solid #7f8c8d; border-radius: 15px; height: 90px; display: flex; justify-content: center; align-items: center; font-size: 35px; font-family: 'Russo One'; cursor: pointer; transition: all 0.1s; box-shadow: 0 6px 0 #1a252f; }
        .ans-btn:hover { background: #34495e; transform: translateY(-4px); border-color: #f1c40f; }
        .ans-btn-correct { background: #27ae60 !important; border-color: #2ecc71 !important; }
        .ans-btn-wrong { background: #c0392b !important; border-color: #e74c3c !important; animation: shake 0.3s; }
        .frac { display: inline-flex; flex-direction: column; vertical-align: middle; margin: 0 5px; font-size: 0.8em; }
        .top { border-bottom: 2px solid white; display: block; text-align: center; line-height: 1.1; }
        .bot { display: block; text-align: center; line-height: 1.1; }

        /* –ú–û–î–ê–õ–ö–ò */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; flex-direction: column; }
        .modal-box { background:#2c3e50; padding:30px; border:4px solid gold; border-radius:20px; text-align:center; box-shadow:0 0 50px black; min-width: 500px; max-width: 700px; position: relative; z-index: 2001; }
        
        /* –ú–ê–ì–ê–ó–ò–ù */
        .shop-section { border-top: 1px solid #555; padding-top: 10px; margin-top: 10px; text-align: left; }
        .shop-section h3 { color: #ddd; margin: 5px 0 10px 0; font-family: 'Russo One'; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px 15px; margin: 5px 0; border-radius: 10px; border: 1px solid #555; }
        .buy-btn { background: #27ae60; border: none; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: 'Russo One'; font-size: 14px; }
        .buy-btn:hover { background: #2ecc71; }
        .buy-btn:disabled { background: #7f8c8d; cursor: not-allowed; }
        
        /* –ê–ß–ò–í–ö–ò */
        .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; }
        .ach-item { background: rgba(0,0,0,0.4); padding: 10px; border: 1px solid #555; border-radius: 8px; display: flex; align-items: center; gap: 10px; opacity: 0.5; filter: grayscale(1); }
        .ach-item.unlocked { opacity: 1; filter: grayscale(0); border-color: gold; background: rgba(255, 215, 0, 0.1); }
        
        /* –ü–û–ë–ï–î–ù–´–ô –≠–ö–†–ê–ù –ò –¢–ò–¢–†–´ */
        .win-stat { font-size: 24px; margin: 10px 0; color: #ddd; }
        .win-stat span { color: gold; font-weight: bold; }

        .credits-box { margin-top: 30px; width: 100%; padding: 20px; border-top: 1px solid #555; border-bottom: 1px solid #555; background: rgba(0,0,0,0.3); animation: slideInUp 1s; }
        .cred-title { font-size: 14px; color: #aaa; letter-spacing: 3px; margin-bottom: 10px; font-family: sans-serif; text-transform: uppercase; }
        .cred-name { font-family: 'Russo One'; font-size: 36px; color: #fff; text-shadow: 0 0 15px #f1c40f; animation: glow 2s infinite alternate; margin-bottom: 5px; }
        .cred-sub { font-family: 'Russo One'; font-size: 22px; color: #f39c12; }
        
        @keyframes glow { from { text-shadow: 0 0 5px #f1c40f; } to { text-shadow: 0 0 25px #f1c40f, 0 0 10px white; } }
        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
    </style>
</head>
<body>

<div id="main-bg"></div>
<button id="fs-btn" onclick="toggleFS()">‚õ∂ –≠–∫—Ä–∞–Ω</button>

<div id="ach-toast">
    <div class="toast-icon">üèÜ</div>
    <div>
        <div class="toast-text">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</div>
        <div id="toast-name" style="font-size:12px;opacity:0.8;">...</div>
    </div>
</div>

<div id="game-wrapper">

    <div id="dialogue-overlay" onclick="nextDialogue()">
        <div class="dia-content">
            <div id="dia-portrait" class="dia-portrait">üòé</div>
            <div class="dia-text-box">
                <div id="dia-name" class="dia-name">–ì–ï–†–û–ô</div>
                <div id="dia-msg" class="dia-msg">...</div>
            </div>
            <div style="font-size:30px; animation:blink 1s infinite;">‚ñ∂</div>
        </div>
    </div>

    <div id="modal-achievements" class="modal-overlay">
        <div class="modal-box">
            <h1 style="color:gold;">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h1>
            <div id="ach-list" class="ach-grid"></div>
            <button class="btn" style="margin-top:20px; background:#555;" onclick="closeAch()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="modal-story" class="modal-overlay">
        <div class="modal-box" style="border-color: #3498db;">
            <h1 id="story-title">–£–†–û–í–ï–ù–¨ –ó–ê–ß–ò–©–ï–ù</h1>
            <div id="story-text-content" style="font-family:'Russo One'; font-size:24px; color:#eee; margin-bottom:30px;">...</div>
            <button class="btn" onclick="proceedNext()">–î–ê–õ–ï–ï ‚ñ∂</button>
        </div>
    </div>

    <div id="modal-loss" class="modal-overlay">
        <div class="modal-box" style="border-color: red;">
            <h1 style="color:red; margin:0;">YOU DIED</h1>
            <button class="btn" onclick="returnToMap()">–ù–ê –ö–ê–†–¢–£</button>
        </div>
    </div>

    <div id="modal-shop" class="modal-overlay">
        <div class="modal-box">
            <h1 style="color:gold; margin:10px;">–ú–ê–ì–ê–ó–ò–ù</h1>
            <div style="font-size: 20px; margin-bottom: 20px;">–¢–≤–æ–µ –∑–æ–ª–æ—Ç–æ: <span id="shop-gold" style="color:yellow">0</span> üí∞</div>
            
            <div class="shop-section">
                <h3>üõ†Ô∏è –°–ù–ê–†–Ø–ñ–ï–ù–ò–ï</h3>
                <div class="shop-item">
                    <div style="text-align:left;"><div style="font-weight:bold; font-size:18px;">‚öîÔ∏è –ó–∞—Ç–æ—á–∫–∞</div><small>+5 –∫ —É—Ä–æ–Ω—É</small></div>
                    <button id="btn-buy-dmg" class="buy-btn" onclick="buyUpgrade('dmg')">100 üí∞</button>
                </div>
                <div class="shop-item">
                    <div style="text-align:left;"><div style="font-weight:bold; font-size:18px;">‚ù§ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div><small>+20 –∫ –ú–∞–∫—Å.HP</small></div>
                    <button id="btn-buy-hp" class="buy-btn" onclick="buyUpgrade('hp')">80 üí∞</button>
                </div>
            </div>

            <div class="shop-section">
                <h3>üéí –†–ê–°–•–û–î–ù–ò–ö–ò</h3>
                <div class="shop-item">
                    <div style="text-align:left;"><div style="font-weight:bold; font-size:18px;">üç∑ –ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è</div><small>–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 50 HP</small></div>
                    <button id="btn-buy-pot" class="buy-btn" onclick="buyItem('potion')">50 üí∞</button>
                </div>
                <div class="shop-item">
                    <div style="text-align:left;"><div style="font-weight:bold; font-size:18px;">üí£ —É—Ä–æ–Ω</div><small>50 —É—Ä–æ–Ω–∞ –≤—Ä–∞–≥—É</small></div>
                    <button id="btn-buy-bomb" class="buy-btn" onclick="buyItem('bomb')">75 üí∞</button>
                </div>
            </div>
            <button class="btn" style="margin-top:20px; background:#555;" onclick="closeShop()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="scr-win" class="screen">
        <h1 style="font-size: 60px; color: gold; text-shadow: 0 0 20px orange; margin-bottom: 10px;">üèÜ –ü–û–ë–ï–î–ê! üèÜ</h1>
        <div style="font-size: 24px; margin-bottom: 20px; font-family:'Russo One';">–¢–´ –°–ü–ê–° –ú–ò–† –ú–ê–¢–ï–ú–ê–¢–ò–ö–ò!</div>
        
        <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 15px; width: 600px; border: 2px solid gold;">
            <div class="win-stat">–ü–æ–≤–µ—Ä–∂–µ–Ω–æ –≤—Ä–∞–≥–æ–≤: <span id="win-kills">0</span> üíÄ</div>
            <div class="win-stat">–†–µ—à–µ–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤: <span id="win-solves">0</span> üß†</div>
            <div class="win-stat">–°–æ–±—Ä–∞–Ω–æ –∑–æ–ª–æ—Ç–∞: <span id="win-gold">0</span> üí∞</div>
        </div>

        <div class="credits-box">
            <div class="cred-title">–†–ê–ó–†–ê–ë–û–¢–ß–ò–ö:</div>
            <div class="cred-name">–î—É–≥–∞–Ω–æ–≤ –ë–∞—Ö—Ç–∏—è—Ä –†–æ–º–∞–Ω–æ–≤–∏—á</div>
            <div class="cred-sub">153 —à–∫–æ–ª–∞ –≥–∏–º–Ω–∞–∑–∏—è 10 "–ê" –∫–ª–∞—Å—Å</div>
        </div>

        <button class="btn" style="margin-top: 20px; background: #27ae60; border-color: #2ecc71;" onclick="location.reload()">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
    </div>

    <div id="scr-hero" class="screen active">
        <h1>–í–´–ë–ï–†–ò –ë–û–ô–¶–ê</h1>
        <div class="hero-grid">
            <div class="hero-card" onclick="pickHero('warrior')"><span class="h-icon">‚öîÔ∏è</span><b>–í–æ–∏–Ω</b><br><small>—Ö–ø 400 –¥–º15</small></div>
            <div class="hero-card" onclick="pickHero('mage')"><span class="h-icon">üßô‚Äç‚ôÇÔ∏è</span><b>–ú–∞–≥</b><br><small>—Ö–ø 150 –¥–º 50 </small></div>
            <div class="hero-card" onclick="pickHero('ninja')"><span class="h-icon">ü•∑</span><b>–ù–∏–Ω–¥–∑—è</b><br><small>—Ö–ø 100 –¥–º60</small></div>
            <div class="hero-card" onclick="pickHero('paladin')"><span class="h-icon">üõ°Ô∏è</span><b>–ü–∞–ª–∞–¥–∏–Ω</b><br><small>–¢–∞–Ω–∫</small></div>
            <div class="hero-card" onclick="pickHero('golem')"><span class="h-icon">üóø</span><b>–ì–æ–ª–µ–º</b><br><small>—Ö–ø 400 –¥–º15</small></div>
            <div class="hero-card" onclick="pickHero('assassin')"><span class="h-icon">üó°Ô∏è</span><b>–ª–æ–≤–∫–∞—á</b><br><small>–£—Ä–æ–Ω+++</small></div>
            <div class="hero-card" onclick="pickHero('priest')"><span class="h-icon">‚öïÔ∏è</span><b>–ñ—Ä–µ—Ü</b><br><small>–•–∏–ª</small></div>
            <div class="hero-card" onclick="pickHero('barbarian')"><span class="h-icon">ü™ì</span><b>–í–∞—Ä–≤–∞—Ä</b><br><small>—Ö–ø 250 –¥–º25</small></div>
        </div>
    </div>

    <div id="scr-world" class="screen">
        <h1>–í–´–ë–û–† –£–†–û–í–ù–Ø</h1>
        <div class="zones-container">
            <button class="btn" onclick="openAch()" style="background:#f39c12; width:100%; margin-bottom:15px;">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>

            <div class="zone-card" style="border-left: 5px solid #2ecc71;">
                <div class="zone-header"><div class="z-title">üå≤ –¢–ï–ú–ù–´–ô –õ–ï–°</div><div class="z-desc">–°–ª–æ–∂–µ–Ω–∏–µ (+)</div></div>
                <div class="levels-row">
                    <button class="lvl-btn" data-z="forest" data-s="1" onclick="pickLevel('forest', 1)">–£—Ä. 1</button>
                    <button class="lvl-btn" data-z="forest" data-s="2" onclick="pickLevel('forest', 2)">–£—Ä. 2</button>
                    <button class="lvl-btn lvl-boss" data-z="forest" data-s="3" onclick="pickLevel('forest', 3)">‚ò†Ô∏è –ë–û–°–°</button>
                </div>
            </div>
            <div class="zone-card" style="border-left: 5px solid #3498db;">
                <div class="zone-header"><div class="z-title">ü¶á –ì–õ–£–ë–û–ö–ê–Ø –ü–ï–©–ï–†–ê</div><div class="z-desc">–£–º–Ω–æ–∂–µ–Ω–∏–µ (√ó)</div></div>
                <div class="levels-row">
                    <button class="lvl-btn" data-z="cave" data-s="1" onclick="pickLevel('cave', 1)">–£—Ä. 1</button>
                    <button class="lvl-btn" data-z="cave" data-s="2" onclick="pickLevel('cave', 2)">–£—Ä. 2</button>
                    <button class="lvl-btn lvl-boss" data-z="cave" data-s="3" onclick="pickLevel('cave', 3)">‚ò†Ô∏è –ë–û–°–°</button>
                </div>
            </div>
            <div class="zone-card" style="border-left: 5px solid #00d2ff;">
                <div class="zone-header"><div class="z-title">‚ùÑÔ∏è –õ–ï–î–Ø–ù–ê–Ø –ü–£–°–¢–û–®–¨</div><div class="z-desc">–î–µ–ª–µ–Ω–∏–µ (:)</div></div>
                <div class="levels-row">
                    <button class="lvl-btn" data-z="ice" data-s="1" onclick="pickLevel('ice', 1)">–£—Ä. 1</button>
                    <button class="lvl-btn" data-z="ice" data-s="2" onclick="pickLevel('ice', 2)">–£—Ä. 2</button>
                    <button class="lvl-btn lvl-boss" data-z="ice" data-s="3" onclick="pickLevel('ice', 3)">‚ò†Ô∏è –ë–û–°–°</button>
                </div>
            </div>
            <div class="zone-card" style="border-left: 5px solid #8e44ad;">
                <div class="zone-header"><div class="z-title">üöÄ –û–¢–ö–†–´–¢–´–ô –ö–û–°–ú–û–°</div><div class="z-desc">–£—Ä–∞–≤–Ω–µ–Ω–∏—è (?)</div></div>
                <div class="levels-row">
                    <button class="lvl-btn" data-z="space" data-s="1" onclick="pickLevel('space', 1)">–£—Ä. 1</button>
                    <button class="lvl-btn" data-z="space" data-s="2" onclick="pickLevel('space', 2)">–£—Ä. 2</button>
                    <button class="lvl-btn lvl-boss" data-z="space" data-s="3" onclick="pickLevel('space', 3)">‚ò†Ô∏è –ë–û–°–°</button>
                </div>
            </div>
            <div class="zone-card" style="border-left: 5px solid #e74c3c;">
                <div class="zone-header"><div class="z-title">üî• –ü–†–ï–ò–°–ü–û–î–ù–Ø–Ø</div><div class="z-desc">–î—Ä–æ–±–∏ (%)</div></div>
                <div class="levels-row">
                    <button class="lvl-btn" data-z="hell" data-s="1" onclick="pickLevel('hell', 1)">–£—Ä. 1</button>
                    <button class="lvl-btn" data-z="hell" data-s="2" onclick="pickLevel('hell', 2)">–£—Ä. 2</button>
                    <button class="lvl-btn lvl-boss" data-z="hell" data-s="3" onclick="pickLevel('hell', 3)">‚ò†Ô∏è –§–ò–ù–ê–õ</button>
                </div>
            </div>
            <div style="display:flex; justify-content:center; align-items:center;">
                <button class="btn" onclick="show('scr-hero')" style="background:#555; width:100%;">üîô –°–ú–ï–ù–ò–¢–¨ –ì–ï–†–û–Ø</button>
            </div>
        </div>
    </div>

    <div id="scr-battle" class="screen">
        <div class="battle-top">
            <button id="surrender-btn" class="btn-small" onclick="surrender()">üè≥Ô∏è –ö–ê–†–¢–ê</button>
            <div class="center-info">
                <div class="stage-bar">
                    <div id="st-1" class="stage-pip active"></div>
                    <div id="st-2" class="stage-pip"></div>
                    <div id="st-3" class="stage-pip"></div>
                </div>
                <div class="top-row-stats">
                    <div id="timer-display" class="timer-box">20</div>
                    <div class="gold-display"><span id="ui-gold">0</span> üí∞</div>
                </div>
            </div>
            <button id="shop-btn" class="btn-small" onclick="openShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
        </div>

        <div class="scene">
            <div class="char">
                <div id="hero-vis" class="char-vis">‚öîÔ∏è</div>
                <div class="hp-bar"><div id="hp-h" class="hp-fill hp-h" style="width:100%"></div></div>
                <div class="hp-text"><span id="val-h">200</span> HP</div>
                <div class="inventory-bar">
                    <div class="inv-item" onclick="useItem('potion')" title="–õ–µ—á–µ–Ω–∏–µ +50">
                        <span class="inv-icon">üç∑</span>
                        <span id="inv-potion" class="inv-count">0</span>
                    </div>
                    <div class="inv-item" onclick="useItem('bomb')" title="–£—Ä–æ–Ω 50">
                        <span class="inv-icon">üí£</span>
                        <span id="inv-bomb" class="inv-count">0</span>
                    </div>
                </div>
            </div>
            <div class="char">
                <div id="enemy-vis" class="char-vis">üê∫</div>
                <div class="hp-bar"><div id="hp-e" class="hp-fill hp-e" style="width:100%"></div></div>
                <div class="hp-text"><span id="val-e">100</span> HP</div>
            </div>
        </div>

        <div class="math-container">
            <div id="math-display" class="math-display">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="answers-grid" class="answers-grid"></div>
        </div>
        <div id="log-msg" style="height:30px; margin-top:5px; color:#bbb; font-style:italic;"></div>
    </div>
</div>

<script>
    const BG_COLORS = {
        main: "linear-gradient(135deg, #2c3e50, #4a3121)",
        forest: "linear-gradient(135deg, #0f2027, #203a43, #2c5364)",
        cave: "linear-gradient(135deg, #141e30, #243b55)",
        ice: "linear-gradient(135deg, #2980b9, #6dd5fa, #ffffff)",
        space: "linear-gradient(135deg, #2c0e37, #000000, #4b0082)",
        hell: "linear-gradient(135deg, #960000, #c0392b, #e74c3c)"
    };
    
    const ACHIEVEMENTS_DATA = [
        { id: 'first', icon: 'ü©∏', title: '–ü–µ—Ä–≤–∞—è –∫—Ä–æ–≤—å', desc: '–£–Ω–µ—á—Ç–æ–∂–∏—Ç—å 1 –≤—Ä–∞–≥–∞' },
        { id: 'hunter', icon: '‚ò†Ô∏è', title: '–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä', desc: '–£–Ω–µ—á—Ç–æ–∂–∏—Ç—å 50 –≤—Ä–∞–≥–æ–≤' },
        { id: 'rich', icon: 'üí∞', title: '–ú–∞–≥–Ω–∞—Ç', desc: '–ù–∞–∫–æ–ø–∏—Ç—å 500 –∑–æ–ª–æ—Ç–∞' },
        { id: 'speed', icon: '‚ö°', title: '–§–ª—ç—à', desc: '–û—Ç–≤–µ—Ç –∑–∞ 2 —Å–µ–∫' },
        { id: 'math', icon: 'üß†', title: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫', desc: '–†–µ—à–∏—Ç—å 20 –ø—Ä–∏–º–µ—Ä–æ–≤' },
        { id: 'survivor', icon: '‚ù§Ô∏è', title: '–í—ã–∂–∏–≤—à–∏–π', desc: '–ü–æ–±–µ–¥–∞ —Å HP < 20%' },
        { id: 'bomber', icon: 'üí£', title: '–ü–æ–¥—Ä—ã–≤–Ω–∏–∫', desc: '–£–Ω–µ—á—Ç–æ–∂–∏—Ç—å  –±–æ–º–±–æ–π' }
    ];

    const DIALOGUES = {
        forest_lvl1: [
            {name: "–ì–ï–†–û–ô", text: "–ù—É –∏ –∑–∞—Ä–æ—Å–ª–∏... –¢—É—Ç –≤–æ–æ–±—â–µ –µ—Å—Ç—å —Ç—Ä–æ–ø–∏–Ω–∫–∞?", who: "hero"},
            {name: "???", text: "–•–†–†–£–°–¢–¨...", who: "enemy", icon: "üå≤"},
            {name: "–ì–ï–†–û–ô", text: "–≠–π, –∫—Ç–æ —Ç–∞–º —Ö—Ä—É—Å—Ç–∏—Ç? –í—ã—Ö–æ–¥–∏, —è –≤–æ–æ—Ä—É–∂–∏–ª—Å—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π!", who: "hero"}
        ],
        forest_lvl2: [
            {name: "–ì–ï–†–û–ô", text: "–§—É—Ö, –∫–æ–º–∞—Ä—ã —Ç—É—Ç —Ä–∞–∑–º–µ—Ä–æ–º —Å –∫—É–ª–∞–∫.", who: "hero"},
            {name: "–î–ò–ö–ò–ô –ö–ê–ë–ê–ù", text: "–•–†–Æ-–•–†–Æ! (–ó–ª–æ–π –≤–∑–≥–ª—è–¥)", who: "enemy", icon: "üêó"},
            {name: "–ì–ï–†–û–ô", text: "–û, –∞ –≤–æ—Ç –∏ —à–∞—à–ª—ã–∫ –ø–æ–±–µ–∂–∞–ª. –°—Ç–æ—è—Ç—å!", who: "hero"}
        ],
        forest_lvl3: [
            {name: "–í–û–ñ–ê–ö", text: "–†—Ä—Ä—Ä... –¢—ã –∑–∞—à–µ–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ, —á–µ–ª–æ–≤–µ–∫.", who: "enemy", icon: "üê∫"},
            {name: "–ì–ï–†–û–ô", text: "–Ø –∏—â—É –≤—ã—Ö–æ–¥. –ò –∑–æ–ª–æ—Ç–æ. –í –æ—Å–Ω–æ–≤–Ω–æ–º –∑–æ–ª–æ—Ç–æ.", who: "hero"},
            {name: "–í–û–ñ–ê–ö", text: "–¢—ã –Ω–∞–π–¥–µ—à—å –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –∫–ª—ã–∫–∏! –í –ê–¢–ê–ö–£!", who: "enemy", icon: "üê∫"}
        ],
        cave_lvl1: [
            {name: "–ì–ï–†–û–ô", text: "–≠—Ö–æ-–æ-–æ! –ï—Å—Ç—å –∫—Ç–æ –¥–æ–º–∞?", who: "hero"},
            {name: "–ì–û–õ–û–°", text: "–£—Ö–æ–¥–∏-–∏-–∏...", who: "enemy", icon: "üëª"},
            {name: "–ì–ï–†–û–ô", text: "–¢–∞–∫, —É –º–µ–Ω—è —Ñ–∞–∫–µ–ª –∏ —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è. –Ø –Ω–µ –±–æ—é—Å—å —Ç–µ–º–Ω–æ—Ç—ã!", who: "hero"}
        ],
        cave_lvl2: [
            {name: "–ì–ï–†–û–ô", text: "–ü–æ–¥ –Ω–æ–≥–∞–º–∏ —Ö—Ä—É—Å—Ç—è—Ç –∫–æ—Å—Ç–∏. –ù–∞–¥–µ—é—Å—å, –∫—É—Ä–∏–Ω—ã–µ.", who: "hero"},
            {name: "–°–ö–ï–õ–ï–¢", text: "–ö–õ–ê–¶-–ö–õ–ê–¶! –°–≤–µ–∂–µ–µ –º—è—Å–æ!", who: "enemy", icon: "üíÄ"},
            {name: "–ì–ï–†–û–ô", text: "–ê —Ç—ã, –ø—Ä–∏—è—Ç–µ–ª—å, —è–≤–Ω–æ –ø—Ä–æ–≥—É–ª–∏–≤–∞–ª —É—Ä–æ–∫–∏ –∞–Ω–∞—Ç–æ–º–∏–∏. –°–µ–π—á–∞—Å —Ä–∞–∑–±–µ—Ä–µ–º!", who: "hero"}
        ],
        cave_lvl3: [
            {name: "–ú–´–®–ò–ù–´–ô –ö–û–†–û–õ–¨", text: "–ü–∏—Å–∫-–ø–∏—Å–∫! –≠—Ç–æ –º–æ—è –≥–æ—Ä–∞ –∑–æ–ª–æ—Ç–∞!", who: "enemy", icon: "ü¶á"},
            {name: "–ì–ï–†–û–ô", text: "–¢—ã –∂–µ –ª–µ—Ç—É—á–∞—è –º—ã—à—å, –∑–∞—á–µ–º —Ç–µ–±–µ –¥–µ–Ω—å–≥–∏?", who: "hero"},
            {name: "–ú–´–®–ò–ù–´–ô –ö–û–†–û–õ–¨", text: "–ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å –æ—á–∫–∏! –Ø —Å–ª–µ–ø–æ–π! –£–ú–†–ò!", who: "enemy", icon: "ü¶á"}
        ],
        ice_lvl1: [
            {name: "–ì–ï–†–û–ô", text: "–ë—Ä—Ä—Ä... –ó—É–± –Ω–∞ –∑—É–± –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç.", who: "hero"},
            {name: "–°–ù–ï–ì–û–í–ò–ö", text: "–ê —Ç—ã –¥—É–º–∞–ª, –≤ —Å–∫–∞–∑–∫—É –ø–æ–ø–∞–ª?", who: "enemy", icon: "‚õÑ"},
            {name: "–ì–ï–†–û–ô", text: "–ì–æ–≤–æ—Ä—è—â–∏–π —Å–Ω–µ–≥–æ–≤–∏–∫? –í–∏–¥–∏–º–æ, —É –º–µ–Ω—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ –æ—Ç —Ö–æ–ª–æ–¥–∞.", who: "hero"}
        ],
        ice_lvl2: [
            {name: "–ì–ï–†–û–ô", text: "–¢—É—Ç —Ç–∞–∫ —Å–∫–æ–ª—å–∑–∫–æ, —á—Ç–æ —è —Å–µ–π—á–∞—Å —Å—è–¥—É –Ω–∞ —à–ø–∞–≥–∞—Ç.", who: "hero"},
            {name: "–ô–ï–¢–ò", text: "–ì–†–ê–ê–ê–†–ì–•!", who: "enemy", icon: "ü•∂"},
            {name: "–ì–ï–†–û–ô", text: "–ë—É–¥—å –∑–¥–æ—Ä–æ–≤! –ò–ª–∏ —Ç—ã –º–µ–Ω—è —Å—ä–µ—Å—Ç—å —Ö–æ—á–µ—à—å?", who: "hero"}
        ],
        ice_lvl3: [
            {name: "–õ–ï–î–Ø–ù–û–ô –ì–û–õ–ï–ú", text: "–¢–í–û–ï. –°–ï–†–î–¶–ï. –°–¢–ê–ù–ï–¢. –õ–¨–î–û–ú.", who: "enemy", icon: "üßä"},
            {name: "–ì–ï–†–û–ô", text: "–ê —Ç–≤–æ–µ —Å–µ—Ä–¥—Ü–µ —Ä–∞—Å—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ —è —Ä–µ—à—É —ç—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä!", who: "hero"},
            {name: "–õ–ï–î–Ø–ù–û–ô –ì–û–õ–ï–ú", text: "–ù–ï–¢! –¢–û–õ–¨–ö–û –ù–ï –î–ï–õ–ï–ù–ò–ï! –ê–ê–ê–†–ì–•!", who: "enemy", icon: "üßä"}
        ],
        space_lvl1: [
            {name: "–ì–ï–†–û–ô", text: "–í–∞—É! –ù–µ–≤–µ—Å–æ–º–æ—Å—Ç—å! –Ø –ª–µ—á—É!", who: "hero"},
            {name: "–ù–õ–û", text: "–ë–∏–ø-–±–æ–ø. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –∂–∏–∑–Ω–∏.", who: "enemy", icon: "üõ∏"},
            {name: "–ì–ï–†–û–ô", text: "–≠–π, –∫—Ç–æ —Ç—É—Ç –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π? –Ø –∑–Ω–∞—é —É—Ä–∞–≤–Ω–µ–Ω–∏—è!", who: "hero"}
        ],
        space_lvl2: [
            {name: "–ì–ï–†–û–ô", text: "–í —Å–∫–∞—Ñ–∞–Ω–¥—Ä–µ —á–µ—à–µ—Ç—Å—è –Ω–æ—Å. –≠—Ç–æ –ø—ã—Ç–∫–∞.", who: "hero"},
            {name: "–†–û–ë–û–¢", text: "–£–ù–ò–ß–¢–û–ñ–ò–¢–¨. –ß–ï–õ–û–í–ï–ö–ê.", who: "enemy", icon: "ü§ñ"},
            {name: "–ì–ï–†–û–ô", text: "–ì–¥–µ —É —Ç–µ–±—è –∫–Ω–æ–ø–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è? –ò–ª–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –±–∏—Ç—å?", who: "hero"}
        ],
        space_lvl3: [
            {name: "–ò–ù–û–ü–õ–ê–ù–ï–¢–Ø–ù–ò–ù", text: "‚çô‚üí ‚èÉ‚çÄ‚üí ‚èÅ‚ä¨‚üí ‚éé‚éç‚èÅ‚éç‚çÄ‚üí.", who: "enemy", icon: "üëΩ"},
            {name: "–ì–ï–†–û–ô", text: "–ß–µ–≥–æ? –ì–æ–≤–æ—Ä–∏ –Ω–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º!", who: "hero"},
            {name: "–ò–ù–û–ü–õ–ê–ù–ï–¢–Ø–ù–ò–ù", text: "–ó–µ–º–ª—è–Ω–µ –≥–ª—É–ø—ã. –ú—ã –∑–∞–±–µ—Ä–µ–º –≤–∞—à –º–æ–∑–≥ –¥–ª—è –æ–ø—ã—Ç–æ–≤.", who: "enemy", icon: "üëΩ"},
            {name: "–ì–ï–†–û–ô", text: "–ú–æ–π –º–æ–∑–≥ –∑–∞–Ω—è—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏! –û—Ç–≤–∞–ª–∏!", who: "hero"}
        ],
        hell_lvl1: [
            {name: "–ì–ï–†–û–ô", text: "–û–π, –≥–æ—Ä—è—á–æ! –ü–æ–ª ‚Äî —ç—Ç–æ –ª–∞–≤–∞. –ë—É–∫–≤–∞–ª—å–Ω–æ!", who: "hero"},
            {name: "–ë–ï–°", text: "–•–∏-—Ö–∏-—Ö–∏! –ü–æ–¥–∂–∞—Ä–∏–º —Ç—É—Ä–∏—Å—Ç–∞!", who: "enemy", icon: "üë∫"},
            {name: "–ì–ï–†–û–ô", text: "–Ø —Ç–µ–±–µ —Å–µ–π—á–∞—Å —Ä–æ–≥–∞ –ø–æ–æ–±–ª–æ–º–∞—é!", who: "hero"}
        ],
        hell_lvl2: [
            {name: "–ì–ï–†–û–ô", text: "–ü–∞—Ö–Ω–µ—Ç —Å–µ—Ä–æ–π –∏ –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏.", who: "hero"},
            {name: "–¶–ï–†–ë–ï–†", text: "–ì–ê–í! –ì–ê–í! –ì–ê–í!", who: "enemy", icon: "üê∫"},
            {name: "–ì–ï–†–û–ô", text: "–•–æ—Ä–æ—à–∏–π –ø—ë—Å–∏–∫... –£ –º–µ–Ω—è –Ω–µ—Ç –∫–æ—Å—Ç–æ—á–∫–∏, –Ω–æ –µ—Å—Ç—å –¥—Ä–æ–±–∏!", who: "hero"}
        ],
        hell_lvl3: [
            {name: "–î–ï–ú–û–ù", text: "–ö–¢–û –ü–û–°–ú–ï–õ –¢–†–ï–í–û–ñ–ò–¢–¨ –ú–ï–ù–Ø?!", who: "enemy", icon: "üëπ"},
            {name: "–ì–ï–†–û–ô", text: "–≠—Ç–æ —è, –ì–µ—Ä–æ–π –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∏! –ü—Ä–∏—à–µ–ª –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç –ø–æ—Ä—Ç–∞–ª!", who: "hero"},
            {name: "–î–ï–ú–û–ù", text: "–¢–´ –û–°–¢–ê–ù–ï–®–¨–°–Ø –ó–î–ï–°–¨ –ù–ê–í–ï–ß–ù–û! –†–ï–®–ê–¢–¨ –ó–ê–î–ê–ß–ò –ë–ï–ó –û–¢–í–ï–¢–û–í!", who: "enemy", icon: "üëπ"},
            {name: "–ì–ï–†–û–ô", text: "–ù—É —É–∂ –Ω–µ—Ç! –ö –±–æ—é!", who: "hero"}
        ]
    };

    const STORY_TEXTS = {
        forest: "–í–æ–ª–∫ –ø–æ–≤–µ—Ä–∂–µ–Ω! –í–ø–µ—Ä–µ–¥–∏ –ø–µ—â–µ—Ä–∞...", cave: "–ú—ã—à—å –ø–∞–ª–∞! –í–∏–¥–µ–Ω —Å–≤–µ—Ç...",
        ice: "–ì–æ–ª–µ–º —Ä–∞–∑–±–∏—Ç! –õ–µ—Ç–∏–º –≤ –∫–æ—Å–º–æ—Å!", space: "–ü—Ä–∏—à–µ–ª—å—Ü—ã —Ä–∞–∑–±–∏—Ç—ã! –ü–æ—Ä—Ç–∞–ª –≤ –ê–¥!", hell: "–î–µ–º–æ–Ω –ø–æ–≤–µ—Ä–∂–µ–Ω! –¢–´ –°–ü–ê–° –ú–ò–†!"
    };
    const ZONE_ORDER = ['forest', 'cave', 'ice', 'space', 'hell'];

    let achievementsState = {}; 
    let stats = { kills: 0, solves: 0 };

    let hero = { hp: 200, max: 200, dmg: 20, gold: 0, icon: '‚öîÔ∏è', inventory: { potion: 1, bomb: 1 } };
    let enemy = { hp: 100, max: 100, dmg: 10 };
    let zone = 'forest', zoneStage = 1, wave = 1;
    let mathAnswer = 0, hellDenom = 1, timer = 20, timerInterval = null;
    let costDmg = 100, costHp = 80;
    let dialogueQueue = [], dialogueCallback = null;
    let unlockedIndex = 0; // 0 = first level

    window.onload = () => { resize(); setBg('main'); updateMapLocks(); };
    window.onresize = resize;
    function resize() { document.getElementById('game-wrapper').style.transform = `scale(${Math.min(window.innerWidth/1000, window.innerHeight/750)})`; }
    function setBg(k) { document.getElementById('main-bg').style.background = BG_COLORS[k] || BG_COLORS.main; }
    function toggleFS() { document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); }
    function show(id) { 
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if(id === 'scr-world') updateMapLocks();
    }

    // --- –õ–û–ì–ò–ö–ê –ó–ê–ú–ö–û–í ---
    function updateMapLocks() {
        let btns = document.querySelectorAll('.lvl-btn');
        btns.forEach(btn => {
            let z = btn.dataset.z;
            let s = parseInt(btn.dataset.s);
            let zIdx = ZONE_ORDER.indexOf(z);
            let globalIdx = zIdx * 3 + (s - 1);

            if(globalIdx > unlockedIndex) {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        });
    }

    // --- –ú–ê–ì–ê–ó–ò–ù ---
    function openShop() { if(hero.hp <= 0) return; stopTimer(); document.getElementById('modal-shop').style.display = 'flex'; updateShopUI(); }
    function closeShop() { document.getElementById('modal-shop').style.display = 'none'; if(document.getElementById('scr-battle').classList.contains('active') && document.getElementById('dialogue-overlay').style.display === 'none') startTimer(); }
    
    function updateShopUI() {
        document.getElementById('shop-gold').innerText = hero.gold;
        let bDmg = document.getElementById('btn-buy-dmg'); bDmg.innerText = `+5 –£—Ä–æ–Ω–∞ (${costDmg}üí∞)`; bDmg.disabled = hero.gold < costDmg;
        let bHp = document.getElementById('btn-buy-hp'); bHp.innerText = `+20 MaxHP (${costHp}üí∞)`; bHp.disabled = hero.gold < costHp;
        
        document.getElementById('btn-buy-pot').disabled = hero.gold < 50;
        document.getElementById('btn-buy-bomb').disabled = hero.gold < 75;
    }

    function buyUpgrade(type) {
        if(type==='dmg' && hero.gold >= costDmg) { hero.gold -= costDmg; hero.dmg += 5; costDmg += 50; log("–ö—É–ø–ª–µ–Ω–æ: –£—Ä–æ–Ω +5"); }
        else if(type==='hp' && hero.gold >= costHp) { hero.gold -= costHp; hero.max += 20; hero.hp += 20; costHp += 40; log("–ö—É–ø–ª–µ–Ω–æ: HP +20"); }
        updateShopUI(); updateUI(); checkAchievements();
    }
    function buyItem(type) {
        let cost = (type === 'potion') ? 50 : 75;
        if(hero.gold >= cost) { hero.gold -= cost; hero.inventory[type]++; log(`–ö—É–ø–ª–µ–Ω–æ: ${type === 'potion' ? '–ó–µ–ª—å–µ' : '–ë–æ–º–±–∞'}!`, 'gold'); }
        updateShopUI(); updateUI();
    }
    function useItem(type) {
        if (hero.inventory[type] > 0) {
            hero.inventory[type]--;
            if (type === 'potion') { hero.hp = Math.min(hero.max, hero.hp + 50); log("–ó–µ–ª—å–µ: +50 HP", "#2ecc71"); }
            else if (type === 'bomb') { enemy.hp -= 50; shake('enemy-vis'); log("–ë–û–ú–ë–ê! -50", "#e74c3c"); if (enemy.hp <= 0) { unlockAchievement('bomber'); winWave(); } }
            updateUI();
        } else log("–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–∞!", "#7f8c8d");
    }

    // --- –ê–ß–ò–í–ö–ò ---
    function openAch() {
        let list = document.getElementById('ach-list'); list.innerHTML = "";
        ACHIEVEMENTS_DATA.forEach(ach => {
            let u = achievementsState[ach.id];
            list.innerHTML += `<div class="ach-item ${u?'unlocked':''}"><div class="ach-icon">${ach.icon}</div><div><div style="font-weight:bold">${ach.title}</div><small>${ach.desc}</small></div></div>`;
        });
        document.getElementById('modal-achievements').style.display = 'flex';
    }
    function closeAch() { document.getElementById('modal-achievements').style.display = 'none'; }
    function unlockAchievement(id) {
        if(achievementsState[id]) return; achievementsState[id] = true;
        let d = ACHIEVEMENTS_DATA.find(x=>x.id===id);
        if(d) { document.getElementById('toast-name').innerText = d.title; let t = document.getElementById('ach-toast'); t.style.top = "20px"; setTimeout(() => t.style.top = "-100px", 3000); }
    }
    function checkAchievements() {
        if(stats.kills >= 1) unlockAchievement('first');
        if(stats.kills >= 50) unlockAchievement('hunter');
        if(hero.gold >= 500) unlockAchievement('rich');
        if(stats.solves >= 20) unlockAchievement('math');
    }

    // --- –õ–û–ì–ò–ö–ê ---
    function startDialogue(k, cb) { if (!DIALOGUES[k]) { if(cb) cb(); return; } dialogueQueue = [...DIALOGUES[k]]; dialogueCallback = cb; showDialogueStep(); }
    function showDialogueStep() {
        if (dialogueQueue.length === 0) { document.getElementById('dialogue-overlay').style.display = 'none'; if(dialogueCallback) dialogueCallback(); return; }
        let l = dialogueQueue[0]; document.getElementById('dialogue-overlay').style.display = 'flex';
        document.getElementById('dia-name').innerText = l.name; document.getElementById('dia-msg').innerText = l.text;
        document.getElementById('dia-portrait').innerText = (l.who==='hero') ? hero.icon : (l.icon||'üíÄ');
        document.getElementById('dia-portrait').style.borderColor = (l.who==='hero') ? '#f1c40f' : '#c0392b';
    }
    function nextDialogue() { dialogueQueue.shift(); showDialogueStep(); }

    function surrender() { if(confirm("–°–¥–∞—Ç—å—Å—è?")) { stopTimer(); show('scr-world'); setBg('main'); } }
    
    function pickHero(t) {
        const i = { warrior:'‚öîÔ∏è', mage:'üßô‚Äç‚ôÇÔ∏è', ninja:'ü•∑', paladin:'üõ°Ô∏è', golem:'üóø', assassin:'üó°Ô∏è', priest:'‚öïÔ∏è', barbarian:'ü™ì' };
        hero.icon = i[t];
        if(t==='golem') { hero.max=400; hero.dmg=15; } else if(t==='mage') { hero.max=150; hero.dmg=40; } else if(t==='warrior') { hero.max=220; hero.dmg=25; } else if(t==='assassin') { hero.max=100; hero.dmg=50; }
        else if(t==='barbarian') { hero.max=250; hero.dmg=25; } else { hero.max=200; hero.dmg=25; }
        hero.hp = hero.max; document.getElementById('hero-vis').innerText = hero.icon; show('scr-world');
    }
    
    function pickLevel(z, s) { 
        zone = z; zoneStage = s; setBg(z); wave = 1; show('scr-battle'); updateStageVisuals(); updateUI();
        let dialogueKey = zone + '_lvl' + s;
        startDialogue(dialogueKey, () => nextWave());
    }

    function startTimer() { stopTimer(); timer = 20; updateTimerVisual(); timerInterval = setInterval(() => { timer--; updateTimerVisual(); if(timer <= 0) { stopTimer(); timeOutPunishment(); } }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }
    function updateTimerVisual() { let el = document.getElementById('timer-display'); el.innerText = timer; if(timer <= 5) el.classList.add('timer-low'); else el.classList.remove('timer-low'); }
    function timeOutPunishment() { log("–í–†–ï–ú–Ø!", "red"); hero.hp -= enemy.dmg; shake('hero-vis'); if(hero.hp <= 0) gameOver(); else { updateUI(); setTimeout(genMath, 1000); } }
    function updateStageVisuals() { for(let i=1; i<=3; i++) { let p = document.getElementById('st-'+i); p.className = 'stage-pip'; if(i < zoneStage) p.classList.add('passed'); if(i === zoneStage) p.classList.add('active'); } }

    function nextWave() {
        let isBoss = (wave % 5 === 0);
        let scale = ZONE_ORDER.indexOf(zone) * 2 + (zoneStage-1) * 2;
        enemy.max = isBoss ? 250 + scale*60 : 70 + scale*25; enemy.hp = enemy.max; enemy.dmg = 10 + scale*4;
        let mobs = { forest: ['üê∫','üêó','üêª'], cave: ['ü¶á','üíÄ','üëÅÔ∏è'], ice: ['‚ùÑÔ∏è','‚õÑ','ü•∂'], space: ['üëΩ','ü§ñ','üõ∏'], hell: ['üî•','üë∫','üëπ'] };
        let ico = (mobs[zone]||mobs.forest)[isBoss ? 2 : Math.floor(Math.random()*2)];
        document.getElementById('enemy-vis').innerText = ico; document.getElementById('enemy-vis').style.fontSize = isBoss ? "200px" : "130px";
        updateUI();
        genMath();
    }

    function genMath() {
        let d = document.getElementById('math-display');
        let html = ""; mathAnswer = 0; let boost = (zoneStage - 1) * 6;
        if (zone === 'space') {
            let r = Math.random();
            if(r < 0.33) { let a=Math.floor(Math.random()*15)+5+boost, b=Math.floor(Math.random()*15)+5; mathAnswer=a; html=`<span class="q-mark">?</span> + ${b} = ${a+b}`; } 
            else if (r < 0.66) { let a=Math.floor(Math.random()*20)+10+boost, b=Math.floor(Math.random()*(a-5))+1; mathAnswer=b; html=`${a} - <span class="q-mark">?</span> = ${a-b}`; } 
            else { let a=Math.floor(Math.random()*8)+2, b=Math.floor(Math.random()*8)+2; mathAnswer=b; html=`${a} √ó <span class="q-mark">?</span> = ${a*b}`; }
        } else if(zone === 'hell') {
            let den=Math.floor(Math.random()*6)+3, n1=Math.floor(Math.random()*(den-1))+1, n2=Math.floor(Math.random()*(den-n1)); if(n2<1) n2=1; mathAnswer=n1+n2; hellDenom=den;
            html=`<span class="frac"><span class="top">${n1}</span><span class="bot">${den}</span></span> + <span class="frac"><span class="top">${n2}</span><span class="bot">${den}</span></span> = ?`;
        } else if (zone === 'ice') {
            let b=Math.floor(Math.random()*9)+2, c=Math.floor(Math.random()*10)+2+zoneStage; mathAnswer=c; html=`${b*c} : ${b} = ?`;
        } else if(zone === 'cave') {
            let a=Math.floor(Math.random()*(9+zoneStage))+2, b=Math.floor(Math.random()*9)+2; mathAnswer=a*b; html=`${a} √ó ${b} = ?`;
        } else { 
            let a=Math.floor(Math.random()*(40+boost)), b=Math.floor(Math.random()*(30+boost)); mathAnswer=a+b; html=`${a} + ${b} = ?`;
        }
        d.innerHTML = html; genButtons(mathAnswer); startTimer();
    }

    function genButtons(corr) {
        let g = document.getElementById('answers-grid'); g.innerHTML = ""; let opts = [corr];
        for(let i=0; i<50; i++) { if(opts.length>=4)break; let f=corr+(Math.floor(Math.random()*20)-10); if(f>0 && f!==corr && !opts.includes(f)) opts.push(f); }
        while(opts.length<4) opts.push(opts[opts.length-1]+1);
        opts.sort(()=>Math.random()-0.5);
        opts.forEach(v => {
            let b = document.createElement('div'); b.className = 'ans-btn';
            if(zone==='hell') b.innerHTML=`<span class="frac"><span class="top">${v}</span><span class="bot">${hellDenom}</span></span>`; else b.innerText=v;
            b.onclick = function() { checkAnswer(v, b); }; g.appendChild(b);
        });
    }

    function checkAnswer(v, b) {
        stopTimer();
        if(v === mathAnswer) {
            let reward = Math.floor(Math.random() * 4) + 2; 
            hero.gold += reward;
            b.classList.add('ans-btn-correct'); log(`–í–µ—Ä–Ω–æ! +${reward} üí∞`, "#2ecc71"); 
            stats.solves++;
            if(timer >= 18) unlockAchievement('speed'); checkAchievements(); updateUI();
            setTimeout(() => { enemy.hp -= hero.dmg; shake('enemy-vis'); if(enemy.hp <= 0) winWave(); else genMath(); updateUI(); }, 300);
        } else {
            b.classList.add('ans-btn-wrong'); log("–û—à–∏–±–∫–∞!", "red"); shake('hero-vis'); hero.hp -= enemy.dmg;
            if(hero.hp <= 0) gameOver(); else { updateUI(); setTimeout(genMath, 500); }
        }
    }

    function winWave() {
        let r = Math.floor(Math.random()*10)+10+(zoneStage*5); hero.gold += r; stats.kills++; log(`–ü–æ–±–µ–¥–∞! +${r} üí∞`, "gold"); wave++;
        if(hero.hp/hero.max < 0.2) unlockAchievement('survivor'); checkAchievements();
        if(wave > 5) { stopTimer(); if (zoneStage < 3) showDialogue("–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù", "–í—Ä–∞–≥–∏ –ø–æ–≤–µ—Ä–∂–µ–Ω—ã!", false); else showDialogue("–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù!", STORY_TEXTS[zone], true); } 
        else nextWave(); 
    }

    function showDialogue(t, txt, fin) {
        document.getElementById('story-title').innerText = t; document.getElementById('story-text-content').innerText = txt;
        document.getElementById('modal-story').style.display = 'flex'; document.getElementById('modal-story').dataset.finish = fin;
    }

    function proceedNext() {
        document.getElementById('modal-story').style.display = 'none';
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å!
        unlockedIndex++;
        
        if (document.getElementById('modal-story').dataset.finish === 'true') {
            let idx = ZONE_ORDER.indexOf(zone);
            if(idx < ZONE_ORDER.length-1) {
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –Ω–æ–≤—É—é –∑–æ–Ω—É (–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞ –∫–∞—Ä—Ç—É)
                show('scr-world');
            } else {
                showVictoryScreen();
            }
        } else { 
            // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–Ω—É—Ç—Ä–∏ –∑–æ–Ω—ã
            zoneStage++; wave=1; 
            updateStageVisuals(); 
            // –°—Ä–∞–∑—É —Å—Ç–∞—Ä—Ç—É–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑ –∫–∞—Ä—Ç—ã
            pickLevel(zone, zoneStage);
        }
    }

    function showVictoryScreen() {
        document.getElementById('win-kills').innerText = stats.kills;
        document.getElementById('win-solves').innerText = stats.solves;
        document.getElementById('win-gold').innerText = hero.gold;
        show('scr-win');
        setBg('main');
    }

    function returnToMap() { document.getElementById('modal-loss').style.display = 'none'; show('scr-world'); setBg('main'); hero.hp = hero.max; }
    function gameOver() { stopTimer(); document.getElementById('modal-loss').style.display = 'flex'; }
    function updateUI() {
        document.getElementById('hp-h').style.width = Math.max(0, (hero.hp/hero.max)*100) + "%"; document.getElementById('val-h').innerText = Math.floor(hero.hp);
        document.getElementById('hp-e').style.width = Math.max(0, (enemy.hp/enemy.max)*100) + "%"; document.getElementById('val-e').innerText = Math.floor(enemy.hp);
        document.getElementById('ui-gold').innerText = hero.gold;
        document.getElementById('inv-potion').innerText = hero.inventory.potion; document.getElementById('inv-bomb').innerText = hero.inventory.bomb;
    }
    function log(t, c) { let l = document.getElementById('log-msg'); l.innerText = t; l.style.color = c||"#bbb"; }
    function shake(id) { let e=document.getElementById(id); e.classList.remove('shake'); void e.offsetWidth; e.classList.add('shake'); }
</script>
</body>

</html>



